name: Self-Healing

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Auto-fix common issues
      run: |
        echo "🔄 Running self-healing checks..."
        
        # Fix missing files
        if [ ! -f "README.md" ]; then
          echo "# Repository" > README.md
          echo "✅ Created missing README.md"
        fi
        
        if [ ! -f "SECURITY.md" ]; then
          cat > SECURITY.md << 'SECURITY_EOF'
# Security Policy
Report security issues to GitHub Security Advisories.
SECURITY_EOF
          echo "✅ Created missing SECURITY.md"
        fi
        
        # Fix README structure
        if ! grep -q "^# " README.md; then
          sed -i '1i# Repository Title' README.md
          echo "✅ Fixed README title"
        fi
        
        # Remove broken badges
        sed -i '/!\[.*\](.*404.*)/d' README.md 2>/dev/null || true
        sed -i '/!\[.*\](.*badge.*error.*)/d' README.md 2>/dev/null || true
        
        # Fix markdown issues
        find . -name "*.md" -exec sed -i 's/\r$//' {} \; 2>/dev/null || true
        
        echo "✅ Auto-fix completed"
        
    - name: Check and fix permissions
      run: |
        echo "🔧 Fixing file permissions..."
        find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
        find . -type f -name "*.md" -exec chmod 644 {} \; 2>/dev/null || true
        echo "✅ Permissions fixed"
        
    - name: Validate and fix workflows
      run: |
        echo "🔍 Validating workflows..."
        
        # Ensure CI workflow exists
        if [ ! -f ".github/workflows/ci.yml" ]; then
          mkdir -p .github/workflows
          cat > .github/workflows/ci.yml << 'CI_EOF'
name: CI
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Basic validation
      run: echo "✅ Repository validated"
CI_EOF
          echo "✅ Created missing CI workflow"
        fi
        
        echo "✅ Workflows validated"
        
    - name: Auto-commit fixes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "✅ No changes to commit"
        else
          git add .
          git commit -m "🔄 auto-fix: self-healing repository maintenance

- Fixed missing or broken files
- Corrected file permissions  
- Validated workflow configurations
- Automated repository health checks" || true
          
          git push || echo "⚠️ Push failed, will retry later"
          echo "✅ Auto-fixes committed"
        fi

  health-check:
    runs-on: ubuntu-latest
    needs: auto-fix
    steps:
    - uses: actions/checkout@v4
    
    - name: Repository health check
      run: |
        echo "🏥 Running health check..."
        
        score=0
        
        # Check required files
        [ -f "README.md" ] && ((score++)) && echo "✅ README.md exists"
        [ -f "SECURITY.md" ] && ((score++)) && echo "✅ SECURITY.md exists"
        [ -f "LICENSE" ] && ((score++)) && echo "✅ LICENSE exists"
        
        # Check README content
        if grep -q "^# " README.md; then
          ((score++))
          echo "✅ README has proper title"
        fi
        
        # Check workflows
        if [ -d ".github/workflows" ]; then
          ((score++))
          echo "✅ Workflows directory exists"
        fi
        
        echo "📊 Health score: $score/5"
        
        if [ $score -ge 4 ]; then
          echo "🎉 Repository is healthy!"
        else
          echo "⚠️ Repository needs attention"
        fi

  auto-update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update dependencies
      run: |
        echo "📦 Checking for updates..."
        
        # Update GitHub Actions versions
        if [ -d ".github/workflows" ]; then
          find .github/workflows -name "*.yml" -exec sed -i 's/actions\/checkout@v3/actions\/checkout@v4/g' {} \;
          find .github/workflows -name "*.yml" -exec sed -i 's/actions\/setup-node@v3/actions\/setup-node@v4/g' {} \;
          echo "✅ Updated action versions"
        fi
        
        # Commit updates if any
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if ! git diff --quiet; then
          git add .
          git commit -m "🔄 auto-update: dependency and action version updates" || true
          git push || true
          echo "✅ Updates committed"
        fi
