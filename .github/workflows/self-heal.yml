name: Self-Healing

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 AM
  workflow_dispatch:

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Auto-fix common issues
      run: |
        echo "ğŸ”„ Running daily self-healing checks..."
        
        if [ ! -f "README.md" ]; then
          echo "# Repository" > README.md
          echo "âœ… Created missing README.md"
        fi
        
        if [ ! -f "SECURITY.md" ]; then
          cat > SECURITY.md << 'SECURITY_EOF'
# Security Policy
Report security issues to GitHub Security Advisories.
SECURITY_EOF
          echo "âœ… Created missing SECURITY.md"
        fi
        
        if ! grep -q "^# " README.md; then
          sed -i '1i# Repository Title' README.md
          echo "âœ… Fixed README title"
        fi
        
        sed -i '/!\[.*\](.*404.*)/d' README.md 2>/dev/null || true
        
        echo "âœ… Daily auto-fix completed"
        
    - name: Auto-commit fixes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "âœ… No changes to commit"
        else
          git add .
          git commit -m "ğŸ”„ daily auto-fix: automated repository maintenance" || true
          git push || echo "âš ï¸ Push failed, will retry tomorrow"
          echo "âœ… Daily fixes committed"
        fi

  health-check:
    runs-on: ubuntu-latest
    needs: auto-fix
    steps:
    - uses: actions/checkout@v4
    
    - name: Daily health check
      run: |
        echo "ğŸ¥ Running daily health check..."
        
        score=0
        [ -f "README.md" ] && ((score++)) && echo "âœ… README.md exists"
        [ -f "SECURITY.md" ] && ((score++)) && echo "âœ… SECURITY.md exists"
        
        echo "ğŸ“Š Daily health score: $score/2"
        echo "âœ… Daily health check completed"
